<!DOCTYPE html>
<html>
<head>
    <title>–ß–∞–π–Ω–∏–∫ Logovo VR</title>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff88;
            text-align: center;
            font-family: 'Courier New', monospace;
            padding: 20px;
            cursor: default;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .teapot {
            font-size: 10em;
            margin: 20px 0;
            transition: transform 0.3s ease;
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .teapot:hover {
            transform: scale(1.1) rotate(10deg);
        }
        .steam {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            opacity: 0;
            pointer-events: none;
        }
        .steam.active {
            animation: steam 2s ease-out forwards;
        }
        @keyframes steam {
            0% { opacity: 0; transform: translateX(-50%) translateY(0); }
            20% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-100px); }
        }
        .message {
            font-size: 2em;
            margin: 20px 0;
            color: #ffaa00;
        }
        .hidden-btn {
            background: transparent;
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s ease;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .hidden-btn:hover {
            opacity: 1;
        }
        .crypto-status {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–µ–º–±–ª–∏–Ω–≥–∞ */
        .gamble-btn {
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ffaa00);
            background-size: 200% 200%;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            margin: 30px auto;
            display: block;
            width: 90%;
            max-width: 500px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
            animation: pulse 2s infinite, gradientShift 3s infinite alternate;
        }
        .gamble-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
            animation: pulse-fast 1s infinite, gradientShift 1.5s infinite alternate;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 255, 0.8); }
        }
        @keyframes pulse-fast {
            0%, 100% { box-shadow: 0 0 25px rgba(255, 0, 255, 0.7); }
            50% { box-shadow: 0 0 35px rgba(0, 255, 255, 0.9); }
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .gamble-warning {
            color: #ffaa00;
            font-size: 0.9em;
            margin-top: 10px;
            text-align: center;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤ */
        .leaderboard-container {
            margin: 40px auto;
            max-width: 800px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        .leaderboard-title {
            color: #ffaa00;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
        }
        .leaderboard-table th {
            background: rgba(0, 255, 136, 0.1);
            padding: 12px;
            border-bottom: 2px solid #00ff88;
            color: #ffaa00;
            text-align: center;
        }
        .leaderboard-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            text-align: center;
        }
        .leaderboard-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        .rank-1 { color: #ffd700; font-weight: bold; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }
        .user-rank {
            background: rgba(0, 255, 136, 0.2);
            border-left: 3px solid #00ff88;
            font-weight: bold;
        }
        .stats-panel {
            margin: 30px auto;
            max-width: 600px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            text-align: left;
        }
        .stats-title {
            color: #ffaa00;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0, 255, 136, 0.3);
        }
        .stat-value {
            color: #00ff88;
            font-weight: bold;
        }
        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .login-prompt {
            margin: 30px 0;
            text-align: center;
        }
        .login-btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s;
        }
        .login-btn:hover {
            background: #00cc66;
            transform: translateY(-2px);
        }
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #8fd493;
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #00ff88;
        }
        .logout-btn {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
            transition: all 0.3s;
        }
        .logout-btn:hover {
            background: rgba(255, 68, 68, 0.4);
        }
        .instructions {
            margin: 20px auto;
            padding: 15px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px dashed #00ff88;
            border-radius: 8px;
            max-width: 600px;
            text-align: left;
            color: #8fd493;
        }
        .instructions h3 {
            color: #ffaa00;
            text-align: center;
            margin-top: 0;
        }
        @media (max-width: 768px) {
            .teapot { font-size: 8em; }
            .gamble-btn { width: 95%; padding: 12px 20px; font-size: 1em; }
            .leaderboard-table { font-size: 0.9em; }
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <div class="status-message" id="statusMessage"></div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div class="user-info" id="userInfo" style="display:none;">
            <span id="userEmail"></span>
            <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- –ß–∞–π–Ω–∏–∫ -->
        <div class="teapot" id="teapot">
            ü´ñ
            <div class="steam" id="steam">‚ô®Ô∏è</div>
        </div>
        
        <div class="message">418 - I'm a teapot</div>
        <div>–ö–ª–∏–∫–∞–π –Ω–∞ –º–µ–Ω—è –∏ –ø–æ–ª—É—á–∏—à—å —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫!</div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
            *50% —á–∞–π (+10), 49.9% –∫–æ—Ñ–µ (+15), 0.1% –∫–≤–∞–Ω—Ç–æ–≤—ã–π (+50)
        </div>

        <!-- –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã -->
        <audio id="boilSound" preload="auto">
            <source src="sounds/boil.mp3" type="audio/mpeg">
        </audio>
        <audio id="successSound" preload="auto">
            <source src="sounds/success.mp3" type="audio/mpeg">
        </audio>
        <audio id="quantumSound" preload="auto">
            <source src="sounds/quantum.mp3" type="audio/mpeg">
        </audio>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <div class="instructions">
            <h3>üìú –ü–†–ê–í–ò–õ–ê –ò–ì–†–´</h3>
            <ul style="padding-left: 20px;">
                <li>–ö–ª–∏–∫–Ω–∏ –Ω–∞ —á–∞–π–Ω–∏–∫ - –ø–æ–ª—É—á–∏ —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫</li>
                <li><strong>50% —à–∞–Ω—Å</strong> - —á–∞–π üçµ (+10 –æ—á–∫–æ–≤)</li>
                <li><strong>49.9% —à–∞–Ω—Å</strong> - –∫–æ—Ñ–µ ‚òï (+15 –æ—á–∫–æ–≤)</li>
                <li><strong>0.1% —à–∞–Ω—Å</strong> - –∫–≤–∞–Ω—Ç–æ–≤—ã–π –Ω–∞–ø–∏—Ç–æ–∫ ‚öõÔ∏è (+50 –æ—á–∫–æ–≤)</li>
                <li>Gambling Mode –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–ª–∏–∫–∞–µ—Ç –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã</li>
            </ul>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="statsSection" style="display:none;">
            <div class="stats-panel">
                <div class="stats-title">üìä –¢–í–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
                <div class="stat-item">
                    <span>üçµ –ß–∞—à–µ–∫ —á–∞—è:</span>
                    <span class="stat-value" id="teaCount">0</span>
                </div>
                <div class="stat-item">
                    <span>‚òï –ß–∞—à–µ–∫ –∫–æ—Ñ–µ:</span>
                    <span class="stat-value" id="coffeeCount">0</span>
                </div>
                <div class="stat-item">
                    <span>‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤—ã—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤:</span>
                    <span class="stat-value" id="quantumCount">0</span>
                </div>
                <div class="stat-item">
                    <span>üî• –í—Å–µ–≥–æ –æ—á–∫–æ–≤:</span>
                    <span class="stat-value" id="totalScore">0</span>
                </div>
                <div class="stat-item">
                    <span>üéØ –°—Ä–µ–¥–Ω–∏–π —Å—á—ë—Ç:</span>
                    <span class="stat-value" id="avgScore">0</span>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ -->
            <div class="leaderboard-container" id="leaderboardContainer">
                <div class="leaderboard-title">üèÜ –ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì</div>
                <div id="leaderboardLoading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
                <table class="leaderboard-table" id="leaderboardTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ò–≥—Ä–æ–∫</th>
                            <th>üçµ –ß–∞–π</th>
                            <th>‚òï –ö–æ—Ñ–µ</th>
                            <th>‚öõÔ∏è –ö–≤–∞–Ω—Ç</th>
                            <th>üî• –û—á–∫–∏</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–º–±–ª–∏–Ω–≥–∞ -->
        <button class="gamble-btn" onclick="startGamblingMode()" id="gambleBtn">
            ‚öõÔ∏è GAMBLING MODE: –ê–í–¢–û-–ö–õ–ò–ö–ï–† (3 —Å–µ–∫)
        </button>
        <div class="gamble-warning" id="gambleStatus">
            –ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–ª–∏–∫–æ–≤
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ Secret -->
        <button class="hidden-btn" onclick="brewCoffeeSecret()">secret</button>
        
        <!-- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤–æ–π—Ç–∏ -->
        <div class="login-prompt" id="loginPrompt">
            <div style="color: #ffaa00; margin-bottom: 15px; font-size: 1.1em;">–í–æ–π–¥–∏—Ç–µ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</div>
            <button class="login-btn" onclick="window.location.href='login.html'">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Supabase</button>
            <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="register.html" style="color: #00ff88;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const SUPABASE_URL = 'https://gdbemyluqtnfytvujfnu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkYmVteWx1cXRuZnl0dnVqZm51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODIwMDAsImV4cCI6MjA4MTM1ODAwMH0.tpEicR_8Bt2R_CIn_kpAZlcXcX8o9CIWXt7mtnAuejg';
        
        let supabase = null;
        let currentUser = null;
        let currentStats = { tea: 0, coffee: 0, quantum: 0, totalScore: 0 };
        let gambleInterval = null;
        let isGamblingActive = false;

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ü´ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞–π–Ω–∏–∫–∞...');
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true, storage: localStorage }
            });
            
            await checkAuth();
            setupTeapot();
        });

        function setupTeapot() {
            const teapot = document.getElementById('teapot');
            
            teapot.addEventListener('click', function() {
                if (!currentUser) {
                    showStatus('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!', false);
                    return;
                }
                brewRandomDrink();
            });
            
            // –§—Ä–∞–∑—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            const phrases = [
                "–ö–ª–∏–∫–Ω–∏ –Ω–∞ –º–µ–Ω—è!",
                "–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–∞—Ä—é?",
                "50% —á–∞–π, 49.9% –∫–æ—Ñ–µ, 0.1% –ö–í–ê–ù–¢!",
                "–ß–∞–π–Ω–∏–∫ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º!",
                "–¢–æ–ª—å–∫–æ –Ω–µ –∂–¥–∏, —á—Ç–æ —è –±—É–¥—É –≤–∞—Ä–∏—Ç—å –∫–æ—Ñ–µ!",
                "418 - —ç—Ç–æ –º–æ–π –∫–æ–¥!",
                "–°–ª—É—á–∞–π–Ω–æ—Å—Ç—å - –º–æ–µ –≤—Ç–æ—Ä–æ–µ –∏–º—è!",
                "–ë—É–¥—å –≥–æ—Ç–æ–≤ –∫ —Å—é—Ä–ø—Ä–∏–∑–∞–º!",
                "Gambling Mode –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!",
                "–ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω!"
            ];
            
            teapot.addEventListener('mouseover', function() {
                const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
                this.title = randomPhrase;
            });
        }

        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        async function checkAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session?.user) {
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = currentUser.email;
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('loginPrompt').style.display = 'none';
                    document.getElementById('statsSection').style.display = 'block';
                    
                    await loadUserStats();
                    await loadGlobalLeaderboard();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
        async function loadUserStats() {
            try {
                // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º –∏–∑ user_stats
                const { data: userStat, error } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                if (userStat) {
                    currentStats = { 
                        tea: userStat.tea_count, 
                        coffee: userStat.coffee_count, 
                        quantum: userStat.quantum_count, 
                        totalScore: userStat.total_points 
                    };
                    
                    document.getElementById('teaCount').textContent = userStat.tea_count;
                    document.getElementById('coffeeCount').textContent = userStat.coffee_count;
                    document.getElementById('quantumCount').textContent = userStat.quantum_count;
                    document.getElementById('totalScore').textContent = userStat.total_points;
                    document.getElementById('avgScore').textContent = userStat.avg_points.toFixed(1);
                } else {
                    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
                    document.getElementById('teaCount').textContent = '0';
                    document.getElementById('coffeeCount').textContent = '0';
                    document.getElementById('quantumCount').textContent = '0';
                    document.getElementById('totalScore').textContent = '0';
                    document.getElementById('avgScore').textContent = '0';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –†–ï–ô–¢–ò–ù–ì–ê ====================
        async function loadGlobalLeaderboard() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const { data: allStats, error } = await supabase
                    .from('leaderboard')
                    .select('user_id, username, drink, score');
                
                if (error) throw error;
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                const userStats = {};
                
                if (allStats && allStats.length > 0) {
                    allStats.forEach(record => {
                        if (!userStats[record.user_id]) {
                            userStats[record.user_id] = {
                                username: record.username || '–ê–Ω–æ–Ω–∏–º',
                                tea: 0,
                                coffee: 0,
                                quantum: 0,
                                totalScore: 0
                            };
                        }
                        
                        if (record.drink === 'tea') userStats[record.user_id].tea++;
                        if (record.drink === 'coffee') userStats[record.user_id].coffee++;
                        if (record.drink === 'quantum') userStats[record.user_id].quantum++;
                        userStats[record.user_id].totalScore += record.score || 0;
                    });
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—á–∫–∞–º
                const leaderboardArray = Object.entries(userStats).map(([userId, stats]) => ({
                    userId,
                    ...stats
                }));
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—á–∫–æ–≤
                leaderboardArray.sort((a, b) => b.totalScore - a.totalScore);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ø-10
                displayLeaderboard(leaderboardArray.slice(0, 10));
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
                document.getElementById('leaderboardLoading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞';
            }
        }

        function displayLeaderboard(data) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('leaderboardLoading').textContent = '–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç';
                return;
            }
            
            data.forEach((user, index) => {
                const row = document.createElement('tr');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const isCurrentUser = currentUser && user.userId === currentUser.id;
                if (isCurrentUser) {
                    row.className = 'user-rank';
                }
                
                // –ö–ª–∞—Å—Å –¥–ª—è —Ç–æ–ø-3
                let rankClass = '';
                if (index === 0) rankClass = 'rank-1';
                else if (index === 1) rankClass = 'rank-2';
                else if (index === 2) rankClass = 'rank-3';
                
                row.innerHTML = `
                    <td><span class="${rankClass}">${index + 1}</span></td>
                    <td>${user.username} ${isCurrentUser ? '(–í—ã)' : ''}</td>
                    <td>${user.tea}</td>
                    <td>${user.coffee}</td>
                    <td>${user.quantum}</td>
                    <td><strong>${user.totalScore}</strong></td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('leaderboardLoading').style.display = 'none';
            document.getElementById('leaderboardTable').style.display = 'table';
        }

        // ==================== –ó–í–£–ö–ò –ò –ê–ù–ò–ú–ê–¶–ò–ò ====================
        function playBoilSound() {
            const audio = document.getElementById('boilSound');
            const steam = document.getElementById('steam');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞—Ä–∞
            if (steam) {
                steam.classList.remove('active');
                void steam.offsetWidth;
                steam.classList.add('active');
            }
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞
            if (audio) {
                audio.currentTime = 0;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', e);
                    });
                }
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }, 5000);
            }
        }

        function playSound(soundId) {
            const audio = document.getElementById(soundId);
            if (audio) {
                audio.currentTime = 0;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.log(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ ${soundId}:`, e);
                    });
                }
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }, 5000);
            }
        }

        function showStatus(message, isSuccess = true) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.style.background = isSuccess ? 
                'linear-gradient(135deg, #00ff88, #00cc66)' : 
                'linear-gradient(135deg, #ff4444, #cc0000)';
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        async function getCryptoRandom() {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] / (0xFFFFFFFF + 1);
        }

        // ==================== –°–õ–£–ß–ê–ô–ù–ê–Ø –í–ê–†–ö–ê ====================
        async function brewRandomDrink() {
            playBoilSound();
            
            setTimeout(async () => {
                const randomValue = await getCryptoRandom();
                
                // 50% —á–∞–π, 49.9% –∫–æ—Ñ–µ, 0.1% –∫–≤–∞–Ω—Ç–æ–≤—ã–π –Ω–∞–ø–∏—Ç–æ–∫
                if (randomValue < 0.5) {
                    // –ß–∞–π
                    await addToLeaderboard('tea', 10);
                    playSound('successSound');
                    showStatus(`üçµ –ß–∞–π –∑–∞–≤–∞—Ä–µ–Ω! +10 –æ—á–∫–æ–≤ (${randomValue.toFixed(4)})`, true);
                } else if (randomValue < 0.999) {
                    // –ö–æ—Ñ–µ
                    await addToLeaderboard('coffee', 15);
                    playSound('successSound');
                    showStatus(`‚òï –ö–æ—Ñ–µ —Å–≤–∞—Ä–µ–Ω–æ! +15 –æ—á–∫–æ–≤ (${randomValue.toFixed(4)})`, true);
                } else {
                    // –ö–í–ê–ù–¢–û–í–´–ô –ù–ê–ü–ò–¢–û–ö!
                    await addToLeaderboard('quantum', 50);
                    playSound('quantumSound');
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è
                    document.body.innerHTML = `
                        <div style="text-align: center; padding: 50px; background: linear-gradient(135deg, #000, #1a0033); color: #fff; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div style="font-size: 5em; animation: spin 3s linear infinite;">‚öõÔ∏èü´ñ</div>
                            <div style="font-size: 2.5em; color: #ff00ff; margin: 20px 0; text-shadow: 0 0 20px #ff00ff;">–ö–í–ê–ù–¢–û–í–ê–Ø –ó–ê–ü–£–¢–ê–ù–ù–û–°–¢–¨!</div>
                            <div style="font-size: 1.2em; margin: 10px 0;">–ù–∞–ø–∏—Ç–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!</div>
                            <div style="color: #00ffff; font-size: 1.5em; margin: 20px 0;">+50 –æ—á–∫–æ–≤!</div>
                            <div style="color: #666; margin: 10px 0;">Crypto-—Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è: ${randomValue.toFixed(6)}</div>
                            <div style="color: #ffaa00; margin: 15px 0; font-size: 1.1em;">–®–∞–Ω—Å: 0.1% | –¢—ã –≤–æ—à—ë–ª –≤ –∏—Å—Ç–æ—Ä–∏—é!</div>
                            <button onclick="location.reload()" style="margin-top: 30px; background: linear-gradient(45deg, #ff00ff, #00ffff); color: #000; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1em;">
                                üîÑ –í–ï–†–ù–£–¢–¨–°–Ø –í –†–ï–ê–õ–¨–ù–û–°–¢–¨
                            </button>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;
                    return;
                }
                
                await loadUserStats();
                await loadGlobalLeaderboard();
            }, 800);
        }

        // ==================== SECRET –ö–ù–û–ü–ö–ê ====================
        async function brewCoffeeSecret() {
            if (!currentUser) {
                showStatus('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!', false);
                return;
            }
            
            playBoilSound();
            
            setTimeout(async () => {
                const randomValue = await getCryptoRandom();
                
                if (randomValue < 0.5) {
                    // –ß–∞–π
                    await addToLeaderboard('tea', 10);
                    playSound('successSound');
                    showStatus(`üîê –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞–π! +10 –æ—á–∫–æ–≤ (${randomValue.toFixed(4)})`, true);
                } else if (randomValue < 0.999) {
                    // –ö–æ—Ñ–µ
                    await addToLeaderboard('coffee', 20); // +20 –æ—á–∫–æ–≤ –∑–∞ —Å–µ–∫—Ä–µ—Ç
                    playSound('successSound');
                    showStatus(`üîê –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ—Ñ–µ! +20 –æ—á–∫–æ–≤ (${randomValue.toFixed(4)})`, true);
                } else {
                    // –ö–≤–∞–Ω—Ç–æ–≤—ã–π
                    await addToLeaderboard('quantum', 100); // +100 –æ—á–∫–æ–≤ –∑–∞ —Å–µ–∫—Ä–µ—Ç
                    playSound('quantumSound');
                    showStatus(`üîê –°–ï–ö–†–ï–¢–ù–´–ô –ö–í–ê–ù–¢! +100 –æ—á–∫–æ–≤ (${randomValue.toFixed(6)})`, true);
                }
                
                await loadUserStats();
                await loadGlobalLeaderboard();
            }, 800);
        }

        // ==================== –ì–ï–ú–ë–õ–ò–ù–ì –ú–û–î ====================
        function startGamblingMode() {
            if (!currentUser) {
                showStatus('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!', false);
                return;
            }
            
            if (isGamblingActive) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–º–±–ª–∏–Ω–≥
                clearInterval(gambleInterval);
                gambleInterval = null;
                isGamblingActive = false;
                document.getElementById('gambleBtn').textContent = '‚öõÔ∏è GAMBLING MODE: –ê–í–¢–û-–ö–õ–ò–ö–ï–† (3 —Å–µ–∫)';
                document.getElementById('gambleStatus').textContent = '–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–ª–∏–∫–æ–≤';
                showStatus('‚ö° Gambling mode –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', false);
                return;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–º–±–ª–∏–Ω–≥
            isGamblingActive = true;
            document.getElementById('gambleBtn').textContent = '‚èπÔ∏è STOP GAMBLING MODE';
            document.getElementById('gambleStatus').textContent = '–ê–≤—Ç–æ-–∫–ª–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã (–∫–∞–∂–¥—ã–µ 3 —Å–µ–∫)';
            showStatus('üé∞ Gambling mode –∑–∞–ø—É—â–µ–Ω (–∫–∞–∂–¥—ã–µ 3 —Å–µ–∫)', true);
            
            // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª–∏–∫–∞
            const autoClick = async () => {
                const randomValue = await getCryptoRandom();
                let drink, score;
                
                if (randomValue < 0.5) {
                    drink = 'tea';
                    score = 10;
                } else if (randomValue < 0.999) {
                    drink = 'coffee';
                    score = 15;
                } else {
                    drink = 'quantum';
                    score = 50;
                }
                
                await addToLeaderboard(drink, score);
                await loadUserStats();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 5 –∫–ª–∏–∫–æ–≤
                if (Math.random() < 0.2) {
                    await loadGlobalLeaderboard();
                }
                
                // –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–ª–∏–∫–µ
                const emoji = drink === 'tea' ? 'üçµ' : drink === 'coffee' ? '‚òï' : '‚öõÔ∏è';
                showStatus(`${emoji} –ê–≤—Ç–æ-–∫–ª–∏–∫: +${score} –æ—á–∫–æ–≤`, true);
            };
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫
            autoClick();
            
            // –ó–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            gambleInterval = setInterval(autoClick, 3000);
        }

        // ==================== –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ====================
        async function addToLeaderboard(drink, score) {
            try {
                let username = currentUser.email.split('@')[0];
                
                // –ü–æ–ª—É—á–∞–µ–º username –∏–∑ profiles
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('username')
                    .eq('id', currentUser.id)
                    .maybeSingle();
                
                if (!profileError && profile?.username) {
                    username = profile.username;
                }
                
                // 1. –í–°–¢–ê–í–õ–Ø–ï–ú –≤ –∏—Å—Ç–æ—Ä–∏—é –≤–∞—Ä–æ–∫ (–¥–ª—è –ª–æ–≥–æ–≤ - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                const { error: historyError } = await supabase
                    .from('brewing_history')  // –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                    .insert({
                        user_id: currentUser.id,
                        username: username,
                        drink: drink,
                        score: score,
                        created_at: new Date().toISOString()
                    });
                
                // 2. –û–ë–ù–û–í–õ–Ø–ï–ú —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: currentStats, error: fetchError } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 = –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', fetchError);
                }
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const current = currentStats || {
                    total_brews: 0,
                    tea_count: 0,
                    coffee_count: 0,
                    quantum_count: 0,
                    total_points: 0,
                    avg_points: 0
                };
                
                const newTotalBrews = current.total_brews + 1;
                const newTeaCount = current.tea_count + (drink === 'tea' ? 1 : 0);
                const newCoffeeCount = current.coffee_count + (drink === 'coffee' ? 1 : 0);
                const newQuantumCount = current.quantum_count + (drink === 'quantum' ? 1 : 0);
                const newTotalPoints = current.total_points + score;
                const newAvgPoints = newTotalBrews > 0 ? newTotalPoints / newTotalBrews : 0;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
                const { error: upsertError } = await supabase
                    .from('user_stats')
                    .upsert({
                        user_id: currentUser.id,
                        username: username,
                        total_brews: newTotalBrews,
                        tea_count: newTeaCount,
                        coffee_count: newCoffeeCount,
                        quantum_count: newQuantumCount,
                        total_points: newTotalPoints,
                        avg_points: newAvgPoints,
                        last_updated: new Date().toISOString()
                    }, {
                        onConflict: 'user_id',
                        ignoreDuplicates: false
                    });
                
                if (upsertError) throw upsertError;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', error);
                showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞', false);
            }
        }

        function logout() {
            if (isGamblingActive) {
                clearInterval(gambleInterval);
            }
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('sb-gdbemyluqtnfytvujfnu-auth-token');
            window.location.reload();
        }
    </script>
</body>
</html>